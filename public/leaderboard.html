<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HEXpostcards - Donation Leaderboard</title>
    
    <!-- Meta tags -->
    <meta name="description" content="Track the top contributors to the HEXpostcards project">
    
    <!-- Facebook -->
    <meta property="og:url" content="https://HEXpostcards.com/leaderboard.html">
    <meta property="og:type" content="website">
    <meta property="og:title" content="HEXpostcards - Donation Leaderboard">
    <meta property="og:description" content="Track the top contributors to the HEXpostcards project">
    <meta property="og:image" content="https://HEXpostcards.com/images/HEXpostcards_DirectMail_Banner_leaderboard_003.png">

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta property="twitter:domain" content="HEXpostcards.com">
    <meta property="twitter:url" content="https://HEXpostcards.com/leaderboard.html">
    <meta name="twitter:title" content="HEXpostcards - Donation Leaderboard">
    <meta name="twitter:description" content="Track the top contributors to the HEXpostcards project">
    <meta name="twitter:image" content="https://HEXpostcards.com/images/HEXpostcards_DirectMail_Banner_leaderboard_003.png">

    <!-- Styles -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="/css/styles.css" rel="stylesheet"> <!-- Your main styles -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="/copyaddress.js"></script>
    <style>
        body { 
            background-color: #111827; 
            color: white; 
            font-family: 'Arial', sans-serif;
        }
        .leaderboard-container {
            background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
            border: 1px solid #374151;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .leaderboard-table {
            width: 100%; 
            border-collapse: collapse; 
            background: transparent;
        }
        .leaderboard-table th, 
        .leaderboard-table td { 
            border: 1px solid #4B5563; 
            padding: 16px; 
            text-align: left; 
        }
        .leaderboard-table th { 
            background: linear-gradient(135deg, #374151 0%, #1f2937 100%); 
            font-weight: bold; 
            font-size: 1.1em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .leaderboard-table tr:nth-child(even) { 
            background-color: rgba(31, 41, 55, 0.5); 
        }        
        .leaderboard-table tr:hover { 
            background-color: rgba(55, 65, 81, 0.7); 
            transform: scale(1.01);
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .address-cell { 
            word-break: break-all; 
            font-family: 'Courier New', monospace; 
            font-size: 0.85em;
            background-color: rgba(0, 0, 0, 0.3);
            padding: 8px;
            border-radius: 4px;
        }
        .rank-cell {
            text-align: center;
            font-weight: bold;
            font-size: 1.2em;
        }
        .amount-cell {
            text-align: right;
            font-weight: bold;
            font-size: 1.1em;
            color: #10B981;
        }
        .top-3 {
            background: linear-gradient(135deg, #FCD34D 0%, #F59E0B 100%);
            color: #000;
        }
        .top-3.rank-1 {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: #000;
        }
        .top-3.rank-2 {
            background: linear-gradient(135deg, #E5E7EB 0%, #D1D5DB 100%);
            color: #000;
        }
        .top-3.rank-3 {
            background: linear-gradient(135deg, #CD7F32 0%, #8B4513 100%);
            color: #FFF;
        }
        /* Override address styling for top 3 ranks */
        .top-3 .address-cell {
            background-color: rgba(0, 0, 0, 0.2);
            color: #000;
            font-weight: 600;
        }
        .top-3 .address-full {
            color: rgba(0, 0, 0, 0.7) !important;
            font-weight: 500;
        }
        .top-3.rank-3 .address-cell {
            color: #FFF;
        }        .top-3.rank-3 .address-full {
            color: rgba(255, 255, 255, 0.8) !important;
        }
        /* Ensure amount cell text is readable for top 3 ranks */
        .top-3 .amount-cell {
            color: #059669;
            font-weight: bold;
        }
        .top-3.rank-3 .amount-cell {
            color: #10B981;
        }
        .address-full {
            font-size: 0.7em; 
            color: #9CA3AF; 
            margin-top: 2px;
            transition: color 0.2s ease;
        }
        .copy-tooltip {
            position: relative;
        }
        .copy-tooltip::after {
            content: 'Click to copy address';
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.7em;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
            z-index: 1000;
        }
        .leaderboard-table tr:hover .copy-tooltip::after {
            opacity: 1;
        }
        .donation-details {
            font-size: 0.9em;
            color: #9CA3AF;
            margin-top: 4px;
        }
        .loading-spinner {
            border: 4px solid #374151;
            border-top: 4px solid #10B981;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .stat-card {
            background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
            border: 1px solid #374151;
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
        }
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #10B981;
        }        .stat-label {
            font-size: 0.9rem;
            color: #9CA3AF;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        /* Copy notification animation */
        .copy-notification {
            transform: translateX(0) !important;
        }
        #copy-success {
            transition: transform 0.3s ease;
        }
    </style>
</head>
<body>
    <div id="navbar"></div>

    <!-- Copy Success Notification -->
    <div id="copy-success" class="fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg transform translate-x-full transition-transform duration-300 z-50">
        Address copied to clipboard!
    </div>

    <div class="container mx-auto px-4 py-8 pt-24">
        <h1 class="text-5xl font-bold text-center mb-4 bg-gradient-to-r from-yellow-400 to-orange-500 bg-clip-text text-transparent">
            Donation Leaderboard
        </h1>
        <p class="text-center text-gray-300 mb-12 text-lg">
            Track the top contributors to the HEXpostcards project
        </p>
        
        <!-- Statistics Summary -->
        <div id="stats-container" class="stats-grid">
            <div class="stat-card">
                <div id="total-donations" class="stat-value">-</div>
                <div class="stat-label">Total Donated</div>
            </div>
            <div class="stat-card">
                <div id="total-donors" class="stat-value">-</div>
                <div class="stat-label">Total Donors</div>
            </div>
            <div class="stat-card">
                <div id="total-transactions" class="stat-value">-</div>
                <div class="stat-label">Total Transactions</div>
            </div>
        </div>

        <!-- Leaderboard Table -->
        <div class="leaderboard-container rounded-lg p-6">
            <div id="loading-message" class="text-center py-8">
                <div class="loading-spinner"></div>
                <p class="text-xl mt-4">Loading leaderboard data...</p>
                <p class="text-sm text-gray-400 mt-2">This may take a moment while we process donation transactions</p>
            </div>
            
            <div id="leaderboard-content" class="hidden">
                <table class="leaderboard-table">                    <thead>
                        <tr>
                            <th style="width: 10%;">Rank</th>
                            <th style="width: 50%;">Donator Address <span style="font-size: 0.7em; font-weight: normal; opacity: 0.7;">(Click to copy)</span></th>
                            <th style="width: 25%;">Total Donated (USD)</th>
                            <th style="width: 15%;">Details</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboard-tbody">
                        <!-- Data will be populated here by JavaScript -->
                    </tbody>
                </table>
            </div>
            
            <div id="error-message" class="hidden text-center py-8">
                <p class="text-xl text-red-400">Failed to load leaderboard data</p>
                <p class="text-sm text-gray-400 mt-2">Please try refreshing the page</p>
            </div>
            
            <div id="empty-message" class="hidden text-center py-8">
                <p class="text-xl text-yellow-400">No donation data available yet</p>
                <p class="text-sm text-gray-400 mt-2">Donations will appear here once processed</p>
            </div>
        </div>    </div>

    <!-- Call to Action -->
    <section class="py-16 bg-blue-900/20">
      <div class="container mx-auto px-4 text-center">
        <h2 class="text-3xl font-bold mb-8">Ready to Get Started?</h2>
        <div class="flex flex-col sm:flex-row gap-4 justify-center">
          <a
            href="/designs.html"
            class="bg-gray-700 hover:bg-gray-600 px-8 py-4 rounded-lg font-medium text-lg transition"
          >
            Browse Designs
          </a>          <a
            href="/donate"
            class="bg-blue-600 hover:bg-blue-700 px-8 py-4 rounded-lg font-medium text-lg transition"
          >
            Donate
          </a>
        </div>
      </div>
    </section>

    <div id="footer"></div>

    <script>
        $(document).ready(function() {
            $('#navbar').load('/navbar.html', function() {
                // Assuming initMobileMenu is global or part of navbar.js loaded content
                if (typeof initMobileMenu === 'function') {
                    initMobileMenu();
                }
            });
            $('#footer').load('/footer.html');

            const socket = io();
            const leaderboardTbody = $('#leaderboard-tbody');
            const leaderboardContent = $('#leaderboard-content');
            const loadingMessage = $('#loading-message');
            const errorMessage = $('#error-message');
            const emptyMessage = $('#empty-message');

            function formatAddress(address) {
                if (!address) return '';
                // Show first 6 and last 4 characters for better readability
                if (address.length > 15) {
                    return address.substring(0, 6) + '...' + address.substring(address.length - 4);
                }
                return address;
            }

            function formatCurrency(amount) {
                return new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'USD',
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                }).format(amount);
            }

            function updateStats(data) {
                if (!data || !Array.isArray(data) || data.length === 0) {
                    $('#total-donations').text('$0');
                    $('#total-donors').text('0');
                    $('#total-transactions').text('0');
                    return;
                }

                const totalDonations = data.reduce((sum, item) => sum + (item.totalUsdValue || 0), 0);
                const totalDonors = data.length;
                const totalTransactions = data.reduce((sum, item) => sum + (item.donationCount || 0), 0);

                $('#total-donations').text(formatCurrency(totalDonations));
                $('#total-donors').text(totalDonors.toLocaleString());
                $('#total-transactions').text(totalTransactions.toLocaleString());
            }

            function populateLeaderboard(data) {
                console.log("Received leaderboard data:", data);
                leaderboardTbody.empty(); // Clear previous data
                
                if (!data || !Array.isArray(data) || data.length === 0) {
                    showEmptyState();
                    return;
                }

                updateStats(data);

                data.forEach(item => {
                    let rankClass = '';
                    if (item.rank === 1) rankClass = 'top-3 rank-1';
                    else if (item.rank === 2) rankClass = 'top-3 rank-2';
                    else if (item.rank === 3) rankClass = 'top-3 rank-3';                    const currencies = item.currencies ? item.currencies.join(', ') : 'ETH';
                    const firstDonationDate = item.firstDonation ? new Date(item.firstDonation * 1000).toLocaleDateString() : '';
                    
                    const row = `<tr class="${rankClass}" data-address="${item.from}" onclick="copyAddress('${item.from}')">
                        <td class="rank-cell">${item.rank}</td>
                        <td class="address-cell copy-tooltip" title="Click to copy: ${item.from}">
                            <div>${formatAddress(item.from)}</div>
                            <div class="address-full">
                                ${item.from}
                            </div>
                        </td>
                        <td class="amount-cell">${formatCurrency(item.totalUsdValue)}</td>
                        <td class="donation-details">
                            <div><strong>${item.donationCount}</strong> donation${item.donationCount !== 1 ? 's' : ''}</div>
                            <div>${currencies}</div>
                            ${firstDonationDate ? `<div>Since: ${firstDonationDate}</div>` : ''}
                        </td>
                    </tr>`;
                    leaderboardTbody.append(row);
                });

                showLeaderboard();
            }

            function showLeaderboard() {
                loadingMessage.addClass('hidden');
                errorMessage.addClass('hidden');
                emptyMessage.addClass('hidden');
                leaderboardContent.removeClass('hidden');
            }

            function showEmptyState() {
                loadingMessage.addClass('hidden');
                errorMessage.addClass('hidden');
                leaderboardContent.addClass('hidden');
                emptyMessage.removeClass('hidden');
                updateStats([]);
            }

            function showError() {
                loadingMessage.addClass('hidden');
                leaderboardContent.addClass('hidden');
                emptyMessage.addClass('hidden');
                errorMessage.removeClass('hidden');
                updateStats([]);
            }

            // Socket.IO event handlers
            socket.on('leaderboardData', function(data) {
                populateLeaderboard(data);
            });

            socket.on('connect', function() {
                console.log('Connected to server');
            });

            socket.on('disconnect', function() {
                console.log('Disconnected from server');
            });

            socket.on('connect_error', function(error) {
                console.error('Connection error:', error);
                showError();
            });

            // Fallback: Try to fetch data via API if socket doesn't work
            setTimeout(function() {
                if (leaderboardTbody.children().length === 0 && !errorMessage.is(':visible') && !emptyMessage.is(':visible')) {
                    console.log('No data received via socket, trying API...');
                    $.get('/api/leaderboard')
                        .done(function(data) {
                            populateLeaderboard(data);
                        })
                        .fail(function(xhr) {
                            console.error('API request failed:', xhr);
                            if (xhr.status === 503) {
                                // Service still loading, show loading state
                                setTimeout(function() {
                                    location.reload();
                                }, 5000);
                            } else {
                                showError();
                            }
                        });
                }
            }, 3000); // Wait 3 seconds for socket data before trying API
        });
    </script>
</body>
</html>
